<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <title></title>
</head>
<body>
<div class="ui container">
    <div class="ui vertically divided grid">
        <div class="row"></div>
        <div class="row">
            <div class="twelve column segment">
                <div class="ui fluid labeled input">
                    <div class="ui label">
                        moduleName
                    </div>
                    <input id="moduleName" class="savable" type="text" placeholder="arduino">
                </div>
                <div class="ui fluid labeled input">
                    <div class="ui label">
                        title
                    </div>
                    <input id="title" class="savable" type="text" placeholder="...">
                </div>
                <div class="ui fluid labeled input">
                    <div class="ui label">
                        description
                    </div>
                    <input id="description" class="savable" type="text" placeholder="...">
                </div>
                <div class="ui fluid labeled input">
                    <div class="ui label">
                        version
                    </div>
                    <input id="version" class="savable" type="text" placeholder="1.00">
                </div>
                <div class="ui fluid labeled icon input">
                    <div class="ui label">blockFile</div>
                    <input id="blockFile" class="savable" type="text" placeholder="/entryjs/src/playground/blocks/hardware/block_arduino.js">
                    <i id="blockFileIcon" class="inverted circular search link icon"></i>
                    <input id="blockFileSelector" style="display: none;" type="file" hidden>
                </div>
                <div class="ui fluid labeled icon input">
                    <div class="ui label" data-tooltip="if empty, it will be hardwareModule's image" data-position="right center">
                        imageFile
                        <i class="question circle icon"></i>
                    </div>
                    <input id="imageFile" class="savable" type="text" placeholder="/entry-hw/app/modules/image.png">
                    <i id="imageFileIcon" class="inverted circular search link icon"></i>
                    <input id="imageFileSelector" style="display: none;" type="file" hidden>
                </div>
                <div class="ui fluid labeled icon input">
                    <div class="ui label">hardwareModulePath</div>
                    <input id="hardwareModulePath" class="savable" type="text" placeholder="/entry-hw/app/modules">
                    <i id="hardwareModulePathIcon" class="inverted circular search link icon"></i>
                    <input id="hardwareModulePathSelector" style="display: none;" type="file" directory webkitdirectory>
                </div>
                <div class="ui fluid labeled input">
                    <div class="ui label">
                        hardwareModuleName
                    </div>
                    <input id="hardwareModuleName" class="savable" type="text" placeholder="arduino">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="twelve column">
                <button id="submit" class="ui secondary button">
                    Okay
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" crossorigin="anonymous"></script>
<script>
    let localStorageData = {};
    $(document).ready(() => {
        initFileSelection('blockFile', 'blockFileIcon', 'blockFileSelector');
        initFileSelection('hardwareModulePath', 'hardwareModulePathIcon', 'hardwareModulePathSelector');
        initFileSelection('imageFile', 'imageFileIcon', 'imageFileSelector');
        $('.savable').on('keydown change', dataSaveFunction);
        $('#submit').on('click', onSubmitData);
        restoreDataFromLocalStorage();
    });

    function initFileSelection(inputElementId, selectIconId, selectorElementId) {
        $(`#${selectIconId}`).on('click', () => {
            $(`#${selectorElementId}`).click();
        });
        $(`#${selectorElementId}`).on('change', (e) => {
            const inputElem = $(`#${inputElementId}`);
            inputElem.val(e.currentTarget.files[0].path);
            inputElem.change();
        });
    }

    function restoreDataFromLocalStorage() {
        if (localStorage) {
            localStorageData = JSON.parse(localStorage.getItem('savedForm') || '{}');

            Object
                .entries(localStorageData)
                .forEach(([key, value]) => {
                $(`#${key}`).val(value);
            });
        }
    }

    function dataSaveFunction() {
        const $this = $(this);
        const value = $this.val();
        const id = $this[0].id;
        if (localStorage) {
            localStorageData[id] = value;
            localStorage.setItem('savedForm', JSON.stringify(localStorageData));
        }
    }

    function onSubmitData() {
        const moduleName = $('#moduleName').val();
        const title = $('#title').val();
        const version = $('#version').val();
        const description = $('#description').val();
        const hardwareModulePath = $('#hardwareModulePath').val();
        const hardwareModuleName = $('#hardwareModuleName').val();
        const blockFilePath = $('#blockFile').val();
        const imageFilePath = $('#imageFile').val();

        if (/^\d+(?:\.\d+)?$/.test(version) === false) {
            alert('version must be number');
            return false;
        }
        if (moduleName === '') {
            alert('moduleName is required');
            return false;
        }
        if (title === '') {
            alert('title is required');
            return false;
        }
        if (hardwareModuleName === '') {
            alert('hardwareModuleName is required');
            return false;
        }

        compressModule({
            moduleName, title, version, description, hardwareModulePath, hardwareModuleName, blockFilePath, imageFilePath
        })
            .then(() => {
                alert('Module Compressed Successfully.');
            })
            .catch((e) => {
                alert('Module Compression Failed. Detail error wrote on devtool console.');
                console.error(e);
            })
    }
</script>
</body>
</html>
